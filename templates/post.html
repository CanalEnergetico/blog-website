{% extends "base.html" %}

{% block title %}{{ articulo.titulo }} ‚Äì Canal Energ√©tico{% endblock %}

{% block content %}
<div class="container">
<!-- Breadcrumbs -->
  <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Inicio</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.articulos_todos') }}">Art√≠culos</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ articulo.titulo }}</li>
    </ol>
  </nav>
<!-- Art√≠culo -->
  <article class="blog-post">
    <h1 class="blog-post-title">{{ articulo.titulo }}</h1>
    <p class="blog-post-meta">
      {{ articulo.fecha }} por
      <a>{{ articulo.autor }}</a>
    </p>

    {% if articulo.img_url %}
      <img
        src="{{ articulo.img_url }}"
        alt="{{ articulo.titulo }}"
        class="img-fluid rounded mb-3 mx-auto d-block"
        style="max-height: 500px; object-fit: cover;">
      {% if articulo.img_fuente %}
        <figcaption class="figure-caption text-end fst-italic">
          Foto: {{ articulo.img_fuente }}
          <p></p>
        </figcaption>
      {% endif %}
    {% endif %}

    <div class="article-content border-bottom">
      {{ articulo.contenido | safe }}
    </div>
  </article>
</div>

<!-- FORMULARIO DE COMENTARIOS -->
<section class="mb-5 mt-4">
  <h3 class="mb-3">üí¨ Deja un comentario</h3>
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          {{ form.nombre.label(class="form-label") }}
          {{ form.nombre(class="form-control", placeholder="Tu nombre") }}
        </div>
        <div class="mb-3">
          {{ form.correo.label(class="form-label") }}
          {{ form.correo(class="form-control", placeholder="Tu correo electr√≥nico") }}
        </div>
        <div class="mb-3">
          {{ form.comentario.label(class="form-label") }}
          {{ form.comentario(class="form-control", rows=3, placeholder="Escribe tu comentario aqu√≠...") }}
        </div>

        <!-- Bot√≥n de enviar -->
        {{ form.submit(class="btn btn-primary px-4") }}

        <!-- Disclaimer con enlace al modal -->
        <p class="text-muted small mt-3 mb-0">
          Al enviar un comentario, aceptas nuestra
          <a href="#" data-bs-toggle="modal" data-bs-target="#modalPrivacidad">Pol√≠tica de Privacidad</a>.
        </p>
      </form>
    </div>
  </div>
</section>

<hr class="my-4">

<!-- LISTA DE COMENTARIOS -->
<section>
  <h3 class="mb-3">üó®Ô∏è Comentarios</h3>
  {% if comentarios %}
    <div class="list-group">
      {% for c in comentarios %}
        <div class="list-group-item list-group-item-action flex-column align-items-start">
          <div class="d-flex w-100 justify-content-between align-items-center">
            <h6 class="mb-1">{{ c.nombre }}</h6>
            <small class="text-muted">
              <!-- ID oculto pero seleccionable -->
              <span class="user-select-all"
                    style="color:transparent; text-shadow: 0 0 0 #ffffff; margin-right: .25rem;">
                #{{ c.id }}
              </span>
              {{ c.fecha }}
            </small>
          </div>
          <p class="mb-1">{{ c.comentario }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted fst-italic">No hay comentarios a√∫n. ¬°S√© el primero en opinar!</p>
  {% endif %}
</section>

<!-- MODAL POL√çTICA DE PRIVACIDAD -->
<div class="modal fade" id="modalPrivacidad" tabindex="-1" aria-labelledby="modalPrivacidadLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrivacidadLabel">Pol√≠tica de Privacidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>En Canal Energ√©tico, valoramos tu privacidad. Los datos personales que compartas con nosotros a trav√©s del formulario (nombre y correo electr√≥nico) ser√°n utilizados √∫nicamente con el prop√≥sito de mostrar tu comentario y facilitar su moderaci√≥n.</p>
        <p>No compartimos tu informaci√≥n con terceros, ni la utilizamos con fines comerciales. Tampoco utilizamos cookies ni tecnolog√≠as de seguimiento propias.</p>
        <p>Este sitio web est√° protegido por reCAPTCHA y se aplican la <a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">Pol√≠tica de Privacidad</a> y los <a href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer">T√©rminos de Servicio</a> de Google.</p>
        <p class="mb-0">Canal Energ√©tico ‚Äì Panam√°</p>
      </div>
    </div>
  </div>
</div>

{# --- Schema.org: NewsArticle (JSON-LD) --- #}
{% set fecha_raw = articulo.fecha %}
{% if fecha_raw is string %}
  {# fecha como 'dd/mm/YYYY' #}
  {% if '/' in fecha_raw %}
    {% set p = fecha_raw.split('/') %}
    {% set iso_fecha = p[2] ~ '-' ~ ("%02d"|format(p[1]|int)) ~ '-' ~ ("%02d"|format(p[0]|int)) %}
  {% else %}
    {# si ya viene como 'YYYY-mm-dd' o similar #}
    {% set iso_fecha = fecha_raw %}
  {% endif %}
{% elif fecha_raw %}
  {# fecha como datetime.date/datetime #}
  {% set iso_fecha = fecha_raw.strftime('%Y-%m-%d') %}
{% else %}
  {% set iso_fecha = '' %}
{% endif %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": {{ (articulo.titulo or "")|tojson }},
  "description": {{ (articulo.descripcion or "")|tojson }},
  "datePublished": {{ (iso_fecha or "")|tojson }},
  "dateModified": {{ (iso_fecha or "")|tojson }},
  "author": {
    "@type": "Person",
    "name": {{ (articulo.autor or "Canal Energ√©tico")|tojson }}
  },
  "publisher": {
    "@type": "Organization",
    "name": "Canal Energ√©tico",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.canalenergetico.com/static/img/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ url_for('main.detalle_articulo', slug=articulo.slug, _external=True) }}"
  },
  "image": [
    {% if articulo.img_url %}
      {{ articulo.img_url|tojson }}
    {% else %}
      "https://www.canalenergetico.com/static/img/default-article.jpg"
    {% endif %}
  ],
  "inLanguage": "es",
  "articleSection": {{ (articulo.tag or "Art√≠culos")|tojson }}
}
</script>

{% endblock %}
