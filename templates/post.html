{% extends "base.html" %}

{% block title %}{{ articulo.titulo }} ‚Äì Canal Energ√©tico{% endblock %}

{% block content %}
<div class="container">
<!-- Breadcrumbs -->
  <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}">Inicio</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.articulos_todos') }}">Art√≠culos</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ articulo.titulo }}</li>
    </ol>
  </nav>
<!-- Art√≠culo -->
  <article class="blog-post">
    <h1 class="blog-post-title">{{ articulo.titulo }}</h1>
    <p class="blog-post-meta">
      {{ articulo.fecha }} por
      <a>{{ articulo.autor }}</a>
    </p>

    {% if articulo.img_url %}
      <img
        src="{{ articulo.img_url }}"
        alt="{{ articulo.titulo }}"
        class="img-fluid rounded mb-3 mx-auto d-block"
        style="max-height: 500px; object-fit: cover;">
      {% if articulo.img_fuente %}
        <figcaption class="figure-caption text-end fst-italic">
          Foto: {{ articulo.img_fuente }}
          <p></p>
        </figcaption>
      {% endif %}
    {% endif %}

    <div class="article-content border-bottom">
      {{ articulo.contenido | safe }}
    </div>

    {% if current_user.is_authenticated and current_user.has_role('admin') %}
  <div class="d-flex gap-2 my-3">
    <a class="btn btn-outline-secondary btn-sm"
       href="{{ url_for('main.editar_articulo', slug=articulo.slug) }}">
      Editar art√≠culo
    </a>

    <form method="post"
          action="{{ url_for('main.delete_post', slug=articulo.slug) }}"
          onsubmit="return confirm('¬øSeguro que quieres eliminar este art√≠culo?');">
      {# Si usas Flask-WTF/CSRFProtect y tienes el token disponible como funci√≥n global: #}
      {# {{ csrf_token() }} #}
      <button type="submit" class="btn btn-outline-danger btn-sm">Eliminar</button>
    </form>
  </div>
{% endif %}

  </article>
</div>

<!-- LISTA DE COMENTARIOS -->
<section>
  <h3 class="mb-3">üó®Ô∏è Comentarios</h3>
  {% if comentarios %}
    <div class="list-group">
      {% for c in comentarios %}
        <div id="c{{ c.id }}" class="list-group-item list-group-item-action flex-column align-items-start">
          <div class="d-flex w-100 align-items-center">
            <h6 class="mb-1 me-auto">{{ c.nombre }}</h6>
            <small class="text-muted me-2">{{ c.fecha }}</small>

            {# Permisos: due√±o o admin #}
            {% set puede_gestionar = (
              current_user.is_authenticated and
              ( current_user.has_role('admin') or current_user.id == c.user_id or current_user.email == c.correo )
            ) %}

            {% if puede_gestionar %}
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                        title="Opciones">
                  &#8942;  {# ‚ãÆ #}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item"
                       href="#"
                       data-bs-toggle="modal"
                       data-bs-target="#editModal-{{ c.id }}">
                      Editar
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form method="post"
                          action="{{ url_for('main.delete_comment', cid=c.id) }}"
                          onsubmit="return confirm('¬øEliminar este comentario?');">
                      {# Si usas CSRF global, descomenta: {{ csrf_token() }} #}
                      <button type="submit" class="dropdown-item text-danger">Borrar</button>
                    </form>
                  </li>
                </ul>
              </div>
            {% endif %}
          </div>

          <p class="mb-1 mt-2">{{ c.comentario }}</p>
        </div>

        {# Modal de edici√≥n inline (sin plantilla aparte) #}
        {% if puede_gestionar %}
        <div class="modal fade" id="editModal-{{ c.id }}" tabindex="-1"
             aria-labelledby="editModalLabel-{{ c.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="post" action="{{ url_for('main.edit_comment', cid=c.id) }}">
                {# Si usas CSRF global, descomenta: {{ csrf_token() }} #}
                <div class="modal-header">
                  <h5 class="modal-title" id="editModalLabel-{{ c.id }}">Editar comentario</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Comentario</label>
                    <textarea name="comentario" class="form-control" rows="4" required>{{ c.comentario }}</textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endif %}

      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted fst-italic">No hay comentarios a√∫n. ¬°S√© el primero en opinar!</p>
  {% endif %}
</section>
<hr class="my-4">

<!-- FORMULARIO DE COMENTARIOS -->
<section class="mb-5 mt-4" id="comentarios">
  <h3 class="mb-3">üí¨ Deja un comentario</h3>

  {% if current_user.is_authenticated %}
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <form method="POST" action="{{ url_for('main.detalle_articulo', slug=articulo.slug) }}">
          <div class="mb-3">
            <label class="form-label">Tu comentario</label>
            <textarea name="comentario" class="form-control" rows="3" placeholder="Escribe tu comentario aqu√≠..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary px-4">Publicar comentario</button>
          <p class="text-muted small mt-3 mb-0">
            Se publicar√° como {{ current_user.nombre }} ({{ current_user.email }}).
          </p>
        </form>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      Para comentar, <a href="{{ url_for('main.login') }}">inicia sesi√≥n</a> o
      <a href="{{ url_for('main.register') }}">crea una cuenta</a>.
    </div>
  {% endif %}
</section>

<hr class="my-4">

<!-- MODAL POL√çTICA DE PRIVACIDAD -->
<div class="modal fade" id="modalPrivacidad" tabindex="-1" aria-labelledby="modalPrivacidadLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPrivacidadLabel">Pol√≠tica de Privacidad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>En Canal Energ√©tico, valoramos tu privacidad. Los datos personales que compartas con nosotros a trav√©s del formulario (nombre y correo electr√≥nico) ser√°n utilizados √∫nicamente con el prop√≥sito de mostrar tu comentario y facilitar su moderaci√≥n.</p>
        <p>No compartimos tu informaci√≥n con terceros, ni la utilizamos con fines comerciales. Tampoco utilizamos cookies ni tecnolog√≠as de seguimiento propias.</p>
        <p>Este sitio web est√° protegido por reCAPTCHA y se aplican la <a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">Pol√≠tica de Privacidad</a> y los <a href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer">T√©rminos de Servicio</a> de Google.</p>
        <p class="mb-0">Canal Energ√©tico ‚Äì Panam√°</p>
      </div>
    </div>
  </div>
</div>

{# --- Schema.org: NewsArticle (JSON-LD) --- #}
{% set fecha_raw = articulo.fecha %}
{% if fecha_raw is string %}
  {# fecha como 'dd/mm/YYYY' #}
  {% if '/' in fecha_raw %}
    {% set p = fecha_raw.split('/') %}
    {% set iso_fecha = p[2] ~ '-' ~ ("%02d"|format(p[1]|int)) ~ '-' ~ ("%02d"|format(p[0]|int)) %}
  {% else %}
    {# si ya viene como 'YYYY-mm-dd' o similar #}
    {% set iso_fecha = fecha_raw %}
  {% endif %}
{% elif fecha_raw %}
  {# fecha como datetime.date/datetime #}
  {% set iso_fecha = fecha_raw.strftime('%Y-%m-%d') %}
{% else %}
  {% set iso_fecha = '' %}
{% endif %}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": {{ (articulo.titulo or "")|tojson }},
  "description": {{ (articulo.descripcion or "")|tojson }},
  "datePublished": {{ (iso_fecha or "")|tojson }},
  "dateModified": {{ (iso_fecha or "")|tojson }},
  "author": {
    "@type": "Person",
    "name": {{ (articulo.autor or "Canal Energ√©tico")|tojson }}
  },
  "publisher": {
    "@type": "Organization",
    "name": "Canal Energ√©tico",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.canalenergetico.com/static/img/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ url_for('main.detalle_articulo', slug=articulo.slug, _external=True) }}"
  },
  "image": [
    {% if articulo.img_url %}
      {{ articulo.img_url|tojson }}
    {% else %}
      "https://www.canalenergetico.com/static/img/default-article.jpg"
    {% endif %}
  ],
  "inLanguage": "es",
  "articleSection": {{ (articulo.tag or "Art√≠culos")|tojson }}
}
</script>

{% endblock %}
