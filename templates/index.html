{% extends "base.html" %}

{% block title %}Inicio – Canal Energético{% endblock %}

{% block content_top %}
<!-- HERO DESTACADO -->
<div class="p-4 p-md-5 mb-4 text-white rounded bg-dark">
  <div class="row align-items-center">
    <div class="col-md-7">
      <h1 class="display-5 fst-italic">¡Bienvenido a tu Canal Energético!</h1>
      <p class="lead my-3">
        ¡Canal Energético es un medio digital independiente creado para compartir noticias de actualidad, análisis y opinión sobre el sector energético de Panamá, la región y el mundo!
      </p>
      <p class="lead mb-0">
        <a href="{{ url_for('main.sobre_nosotros') }}" class="text-white fw-bold">Sobre nosotros</a>
      </p>
    </div>
    <div class="col-md-5 text-center" style="height: 100%;">
      <img src="{{ url_for('static', filename='images/canal-hero.png') }}"
           alt="Canal Energetico Hero"
           class="img-fluid rounded w-100 h-100"
           style="object-fit: cover;">
    </div>
  </div>
</div>

<!-- CARDS -->
<div class="row mb-4">
  <div class="col-12">
    <h3 class="pb-4 mb-2 fst-italic border-bottom">Últimos artículos</h3>
  </div>
</div>

<!-- Dos tarjetas (excluye el destacado) -->
<div class="row mb-2">
  {% for articulo in (otros[:2] if otros else []) %}
  <div class="col-md-6">
    <div class="row g-0 border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
      <div class="col p-4 d-flex flex-column position-static truncate-1">
        <strong class="d-inline-block mb-2 {{ 'text-primary' if loop.index==1 else 'text-success' }}">
          {# Mostrar tag M2M si existe; si no, legacy 'tag' #}
          {% if articulo.tags and articulo.tags|length > 0 %}
            {{ articulo.tags[0].nombre }}
          {% else %}
            {{ articulo.tag }}
          {% endif %}
        </strong>
        <h4 class="mb-0 truncate-2">{{ articulo.titulo }}</h4>
        <div class="mb-1 text-body-secondary">{{ articulo.fecha }} | {{ articulo.autor }}</div>
        <p class="mb-auto truncate-2">{{ articulo.descripcion }}</p>
        <a href="{{ url_for('main.detalle_articulo', slug=articulo.slug) }}" class="icon-link gap-1 icon-link-hover stretched-link">
          Seguir leyendo
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
               class="bi bi-chevron-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
          </svg>
        </a>
      </div>
      <div class="col-auto d-none d-lg-block">
        {% if articulo.img_url %}
          <img
            src="{{ articulo.img_url }}"
            alt="{{ articulo.titulo }}"
            class="bd-placeholder-img rounded"
            style="object-fit: cover; height: 250px; width: 200px;">
        {% else %}
          <img
            src="{{ url_for('static', filename='imagen/logo_canal_en.png') }}"
            alt="Logo Canal Energético"
            class="bd-placeholder-img rounded"
            style="object-fit: cover; width:200px; height:250px;">
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{# ===================== OPINIÓN DE EXPERTOS ===================== #}
{% macro opinion_card(nombre, avatar_path) %}
  {# Posts disponibles en esta vista: destacado + otros (ordenados de nuevo a antiguo) #}
  {% set posts = (([destacado] if destacado else []) + (otros or [])) %}

  {# Buscar el post de opinión más reciente del autor #}
  {% set ns = namespace(post=None) %}
  {% for a in posts %}
    {% set tags_str = '' %}
    {% if a.tags %}
      {% set tag_names = a.tags | map(attribute='nombre') | list %}
      {% set tag_slugs = a.tags | map(attribute='slug') | list %}
      {% set tags_str = (tag_names|join(',') ~ ',' ~ tag_slugs|join(',')) | lower %}
    {% endif %}
    {% set legacy_opinion = (a.tag and ('opin' in (a.tag|lower))) %}
    {% set is_opinion = ('opinion' in tags_str) or ('opinión' in tags_str) or legacy_opinion %}
    {% if ns.post is none and a.autor == nombre and is_opinion %}
      {% set ns.post = a %}
    {% endif %}
  {% endfor %}

  <div class="col text-center">
    <img src="{{ url_for('static', filename=avatar_path) }}"
         alt="{{ nombre }}"
         class="rounded-circle mb-2"
         style="width: 120px; height: 120px; object-fit: cover; border: 2px solid #ccc;">
    <h5 class="text-primary mt-2">{{ nombre }}</h5>

    {% if ns.post %}
      <p class="text-muted small">{{ ns.post.fecha }}</p>
      <h6 class="fst-italic mb-3" style="min-height: 72px;">{{ ns.post.titulo }}</h6>
      <a href="{{ url_for('main.detalle_articulo', slug=ns.post.slug) }}" class="btn btn-outline-primary btn-sm">Leer más</a>
    {% else %}
      <p class="text-muted small">No hay columnas disponibles.</p>
    {% endif %}
  </div>
{% endmacro %}

<div class="row mb-4">
  <div class="col-12">
    <h3 class="pb-4 mb-2 fst-italic border-bottom">Opinión de expertos</h3>
  </div>
</div>

{# Auto grid: 2 columnas en móvil, 4 en md+, con gap #}
<div class="row row-cols-2 row-cols-md-4 g-4 mb-5">
  {{ opinion_card('Irving Henry', 'images/irving.png') }}
  {{ opinion_card('Rafael Jaén Williamson', 'images/rafael-jaen.png') }}
  {# añade más autores repitiendo la línea de arriba #}
</div>


{% endblock %}

{% block content %}
<!-- Directo al voltaje -->
<div class="row g-5">
  <div class="col-md-12">
    <h3 class="pb-4 mb-4 fst-italic border-bottom">Directo al voltaje</h3>

    {% if destacado %}
    <article class="blog-post">
      <h1 class="blog-post-title">{{ destacado.titulo }}</h1>
      <p class="blog-post-meta">
        {{ destacado.fecha }} por <a>{{ destacado.autor }}</a>
      </p>

      {% if destacado.img_url %}
        <img
          src="{{ destacado.img_url }}"
          alt="{{ destacado.titulo }}"
          class="img-fluid rounded mb-3 mx-auto d-block"
          style="max-height: 500px; object-fit: cover;">
        {% if destacado.img_fuente %}
          <figcaption class="figure-caption text-end fst-italic">
            Foto: {{ destacado.img_fuente }}
            <p></p>
          </figcaption>
        {% endif %}
      {% else %}
        <img
          src="{{ url_for('static', filename='imagen/logo_canal_en.png') }}"
          alt="Logo Canal Energético"
          class="bd-placeholder-img rounded"
          style="object-fit: cover; width:200px; height:250px;">
      {% endif %}

      <div class="article-content">
        {{ destacado.contenido | safe }}
      </div>
    </article>
    {% else %}
      <p class="text-muted">Aún no hay artículos publicados.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
