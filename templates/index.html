{% extends "base.html" %}

{% block title %}Inicio – Canal Energético{% endblock %}

{% block content_top %}
<!-- HERO -->
<div class="p-4 p-md-5 mb-4 text-white rounded bg-dark">
  <div class="row align-items-center">
    <div class="col-md-7">
      <h1 class="display-5 fst-italic">¡Bienvenido a tu Canal Energético!</h1>
      <p class="lead my-3">
        ¡Canal Energético es un medio digital independiente creado para compartir noticias de actualidad, análisis y opinión sobre el sector energético de Panamá, la región y el mundo!
      </p>
      <p class="lead mb-0">
        <a href="{{ url_for('main.sobre_nosotros') }}" class="text-white fw-bold">Sobre nosotros</a>
      </p>
    </div>
    <div class="col-md-5 text-center" style="height: 100%;">
      <img src="{{ url_for('static', filename='images/canal-hero.png') }}"
           alt="Canal Energetico Hero"
           class="img-fluid rounded w-100 h-100"
           style="object-fit: cover;">
    </div>
  </div>
</div>

<!--TARJETAS DE ARTÍCULOS DESTACADOS-->
<div class="row mb-4">
  <div class="col-12">
    <h3 class="pb-4 mb-2 fst-italic border-bottom">Últimos artículos</h3>
  </div>
</div>

<div class="row mb-2">
  {% for articulo in (otros[:2] if otros else []) %}
  <div class="col-md-6">
    <div class="row g-0 border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">
      <div class="col p-4 d-flex flex-column position-static truncate-1">
{# decide el tag principal #}
{% set primary = articulo.tag %}
{% if not primary and articulo.tags and articulo.tags|length > 0 %}
  {% set primary = (articulo.tags|sort(attribute='id')|first).nombre %}
{% endif %}

<strong class="d-inline-block mb-2 fw-bold text-{{ primary|tag_color }}">
  {{ primary }}
</strong>



        <h4 class="mb-0 truncate-2">{{ articulo.titulo }}</h4>
        <div class="mb-1 text-body-secondary">{{ articulo.fecha }} | {{ articulo.autor }}</div>
        <p class="mb-auto truncate-2">{{ articulo.descripcion }}</p>
        <a href="{{ url_for('blog.detalle_articulo', slug=articulo.slug) }}" class="icon-link gap-1 icon-link-hover stretched-link">
          Seguir leyendo
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
               class="bi bi-chevron-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
          </svg>
        </a>
      </div>
      <div class="col-auto d-none d-lg-block">
        {% if articulo.img_url %}
          <img src="{{ articulo.img_url }}" alt="{{ articulo.titulo }}"
               class="bd-placeholder-img rounded" style="object-fit: cover; height: 250px; width: 200px;">
        {% else %}
          <img src="{{ url_for('static', filename='imagen/logo_canal_en.png') }}" alt="Logo Canal Energético"
               class="bd-placeholder-img rounded" style="object-fit: cover; width:200px; height:250px;">
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block content %}
{% macro opinion_card(nombre, avatar_path, linkedin_url=None) %}
  {% set posts = (([destacado] if destacado else []) + (otros or [])) %}
  {% set nombre_norm = (nombre | lower | replace(' ', '') | trim) %}

  {% set ns = namespace(post=None) %}
  {% for a in posts %}
    {% set tags_str = '' %}
    {% if a.tags %}
      {% set tag_names = a.tags | map(attribute='nombre') | list %}
      {% set tag_slugs = a.tags | map(attribute='slug') | list %}
      {% set tags_str = (tag_names|join(',') ~ ',' ~ tag_slugs|join(',')) | lower %}
    {% endif %}
    {% set legacy_opinion = (a.tag and ('opin' in (a.tag|lower))) %}
    {% set is_opinion = ('opinion' in tags_str) or ('opinión' in tags_str) or legacy_opinion %}
    {% set autor_norm = (a.autor | lower | replace(' ', '') | trim) %}
    {% set autor_match = (autor_norm == nombre_norm) or (nombre_norm in autor_norm) %}
    {% if ns.post is none and autor_match and is_opinion %}
      {% set ns.post = a %}
    {% endif %}
  {% endfor %}

  {% if ns.post is none %}
    {% for a in posts %}
      {% set autor_norm = (a.autor | lower | replace(' ', '') | trim) %}
      {% if ns.post is none and ((autor_norm == nombre_norm) or (nombre_norm in autor_norm)) %}
        {% set ns.post = a %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <div class="col-auto d-flex flex-column align-items-center text-center">
    <img src="{{ url_for('static', filename=avatar_path) }}"
         alt="{{ nombre }}" class="rounded-circle mb-2"
         style="width: 120px; height: 120px; object-fit: cover; border: 2px solid #ccc;">

    <h5 class="mt-2 d-inline-flex align-items-center justify-content-center text-primary" style="gap:.35rem;">
      <span>{{ nombre }}</span>
      {% if linkedin_url %}
        <a href="{{ linkedin_url }}" target="_blank" rel="noopener" aria-label="LinkedIn de {{ nombre }}" class="text-reset" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
            <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0
            .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542
            v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4
            3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586
            .173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184
            -3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4
            c.03.678 0 7.225 0 7.225z"/>
          </svg>
        </a>
      {% endif %}
    </h5>

    {% if ns.post %}
      <p class="text-muted small mb-1">{{ ns.post.fecha }}</p>

      <h6 class="fst-italic mb-1">{{ ns.post.titulo }}</h6>

      {% set _desc = ns.post.descripcion if ns.post.descripcion else (ns.post.contenido | striptags) %}
      {% set _desc = _desc[:220] ~ ('…' if (_desc|length) > 220 else '') %}
      <p class="text-muted small fst-italic mb-3">{{ _desc }}</p>

      <a href="{{ url_for('blog.detalle_articulo', slug=ns.post.slug) }}" class="btn btn-outline-primary btn-sm">Leer más</a>
    {% else %}
      <p class="text-muted small">No hay columnas disponibles.</p>
    {% endif %}
  </div>
{% endmacro %}

<!--OPINIÓN DE EXPERTOS-->
<h3 class="pb-4 mb-4 fst-italic border-bottom">Opinión de expertos</h3>
<div class="row justify-content-center gx-2 gy-3 mb-5">
  {{ opinion_card('Rafael Jaén Williamson', 'images/rafael-jaen.png', 'https://www.linkedin.com/in/rafael-ja%C3%A9n-williamson-338288b8/') }}
</div>

<!--ARTÍCULO DE DIRECTO AL VOLTAJE-->
<h3 class="pb-4 mb-4 fst-italic border-bottom">Directo al voltaje</h3>
<article class="blog-post px-3">
  {% if destacado %}
    <h1 class="blog-post-title">{{ destacado.titulo }}</h1>
    <p class="blog-post-meta">{{ destacado.fecha }} por <a>{{ destacado.autor }}</a></p>

    {% if destacado.img_url %}
      <img src="{{ destacado.img_url }}" alt="{{ destacado.titulo }}"
           class="img-fluid rounded mb-3 mx-auto d-block" style="max-height: 500px; object-fit: cover;">
      {% if destacado.img_fuente %}
        <figcaption class="figure-caption text-end fst-italic">Foto: {{ destacado.img_fuente }}<p></p></figcaption>
      {% endif %}
    {% else %}
      <img src="{{ url_for('static', filename='imagen/logo_canal_en.png') }}" alt="Logo Canal Energético"
           class="bd-placeholder-img rounded" style="object-fit: cover; width:200px; height:250px;">
    {% endif %}

    <div class="article-content">{{ destacado.contenido | safe }}</div>
  {% else %}
    <p class="text-muted">Aún no hay artículos publicados.</p>
  {% endif %}
</article>
{% endblock %}
