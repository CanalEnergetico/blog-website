{% extends "base.html" %}
{% block title %}Registrarse – Canal Energético{% endblock %}

{% block content_top %}
  <div class="bg-light p-3 rounded mb-4">
    <h1 class="mb-1">Crear cuenta</h1>
    <p class="mb-0 text-muted">
      Únete a Canal Energético, una comunidad para descubrir cómo funciona el
      sistema eléctrico nacional y aprender juntos en el camino.
      Al registrarte podrás comentar y acceder a toda la normativa.
      Solo verifica tu correo y listo.
    </p>
  </div>
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <form method="post" action="{{ url_for('auth.registrarse') }}" class="card p-3 shadow-sm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- Nombre -->
        <div class="form-floating mb-3">
          <input id="nombre" name="nombre" type="text" class="form-control" placeholder="Tu nombre" value="{{ nombre or '' }}" required autofocus>
          <label for="nombre">Nombre</label>
        </div>
        <!-- Email -->
        <div class="form-floating mb-3">
          <input id="email" name="email" type="email" class="form-control" placeholder="tucorreo@ejemplo.com" value="{{ email or '' }}" required>
          <label for="email">Email</label>
        </div>
        <!-- Contraseña -->
        <div class="form-floating mb-3 position-relative">
          <input id="password" name="password" type="password" class="form-control pe-5" placeholder="Tu contraseña" required minlength="8" autocomplete="new-password">
          <label for="password">Contraseña</label>
          <!-- Botón ojo -->
          <button type="button"
                  class="btn btn-sm position-absolute top-50 end-0 translate-middle-y me-2"
                  id="togglePassword"
                  aria-label="Mostrar contraseña"
                  title="Mostrar contraseña">
            <i class="bi bi-eye" id="togglePasswordIcon" aria-hidden="true"></i>
          </button>
        </div>
        <!-- Confirmar contraseña -->
        <div class="form-floating mb-3">
          <input id="confirm_password" name="confirm_password" type="password" class="form-control" placeholder="Repite tu contraseña" required>
          <label for="confirm_password">Confirmar contraseña</label>
        </div>
        <!-- Indicador de fuerza -->
        <div class="mb-3">
          <small class="form-text">Fortaleza de la contraseña:</small>
          <div class="progress">
            <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%">Débil</div>
          </div>
        </div>
        <!-- Botón y aviso legal -->
        <div class="mt-3">
          <button type="submit" class="btn btn-primary w-100">Crear cuenta</button>
          <p class="text-muted small mt-2 mb-0">
          Al registrarte aceptas nuestras
          <a href="{{ url_for('auth.privacy') }}" target="_blank" rel="noopener noreferrer">condiciones de uso</a>.
        </p>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Mostrar / ocultar contraseña con icono
  (function() {
    const btn = document.getElementById("togglePassword");
    const icon = document.getElementById("togglePasswordIcon");
    const field = document.getElementById("password");

    btn.addEventListener("click", function () {
      const isPassword = field.getAttribute("type") === "password";
      field.setAttribute("type", isPassword ? "text" : "password");
      icon.classList.toggle("bi-eye", !isPassword);
      icon.classList.toggle("bi-eye-slash", isPassword);
      btn.setAttribute("aria-label", isPassword ? "Ocultar contraseña" : "Mostrar contraseña");
      btn.setAttribute("title", isPassword ? "Ocultar contraseña" : "Mostrar contraseña");
    });
  })();

  // Confirmación de contraseña
  (function() {
    const password = document.getElementById("password");
    const confirmPassword = document.getElementById("confirm_password");
    const validate = () => {
      if (confirmPassword.value && confirmPassword.value !== password.value) {
        confirmPassword.setCustomValidity("Las contraseñas no coinciden.");
      } else {
        confirmPassword.setCustomValidity("");
      }
    };
    password.addEventListener("input", validate);
    confirmPassword.addEventListener("input", validate);
  })();

  // Indicador de fuerza
  (function() {
    const password = document.getElementById("password");
    const strengthBar = document.getElementById("passwordStrength");

    password.addEventListener("input", () => {
      const val = password.value;
      let strength = 0;
      if (val.length >= 8) strength++;
      if (/[A-Z]/.test(val)) strength++;
      if (/[0-9]/.test(val)) strength++;
      if (/[^A-Za-z0-9]/.test(val)) strength++;

      const percents = ["0%", "25%", "50%", "75%", "100%"];
      const labels   = ["Débil", "Regular", "Buena", "Fuerte", "Muy fuerte"];
      const classes  = ["bg-danger", "bg-warning", "bg-info", "bg-primary", "bg-success"];

      strengthBar.style.width = percents[strength];
      strengthBar.textContent = labels[strength];
      strengthBar.className = "progress-bar " + classes[strength];
    });
  })();
</script>
{% endblock %}
