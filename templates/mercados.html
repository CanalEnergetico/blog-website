{% extends "base.html" %}
{% block title %}Mercados – Canal Energético{% endblock %}

{% block content_top %}
<div class="bg-light p-3 rounded mb-4">
  <h1 class="mb-1">Mercados Energéticos</h1>
  <p class="mb-0 text-muted">
    Aquí encontrarás indicadores clave de los mercados de <strong>petróleo</strong> que seguimos a diario.
    Actualizamos los datos varias veces al día y mostramos la evolución de los últimos 30 días para que puedas
    ver la tendencia reciente de un vistazo.
  </p>
</div>
{% endblock %}

{% block content %}

<style>
  .chg-wrap{ font-size:1.05rem; }
  .chg-val{ font-weight:600; }
  .equal-col { display: flex; }
  .equal-card { display: flex; flex-direction: column; width: 100%; }

  .price-row{
    display:flex;
    align-items:baseline;
    gap:1rem;
    flex-wrap:nowrap;
  }
  .price-pair{
    display:flex;
    align-items:baseline;
    gap:.5rem;
    white-space:nowrap;
  }
  .chg-wrap{ white-space:nowrap; }

  @media (max-width: 576px){
    .price-row{ flex-wrap:wrap; }
  }
</style>

<div class="row g-3">
  <!-- Brent -->
  <div class="col-md-6 equal-col">
    <div class="card shadow-sm equal-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Brent</h5>
          <span class="badge bg-secondary" id="brentStale" style="display:none;">Dato no reciente</span>
        </div>

        <div class="price-row mt-2">
          <div class="price-pair">
            <span class="display-6 fw-semibold" id="brentValue">—</span>
            <span class="text-muted" id="brentUnit">USD/bbl</span>
          </div>
          <div class="chg-wrap text-muted">
            10d: <span id="brent10d" class="chg-val">—</span>
            &nbsp;·&nbsp;
            30d: <span id="brent30d" class="chg-val">—</span>
          </div>
        </div>

        <div class="small text-muted mt-1">
          Último dato: <span id="brentLastDate">—</span>
        </div>

        <canvas id="chartBrent" height="140" class="mt-3"></canvas>
      </div>
    </div>
  </div>

  <!-- WTI -->
  <div class="col-md-6 equal-col">
    <div class="card shadow-sm equal-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">WTI</h5>
          <span class="badge bg-secondary" id="wtiStale" style="display:none;">Dato no reciente</span>
        </div>

        <div class="price-row mt-2">
          <div class="price-pair">
            <span class="display-6 fw-semibold" id="wtiValue">—</span>
            <span class="text-muted" id="wtiUnit">USD/bbl</span>
          </div>
          <div class="chg-wrap text-muted">
            10d: <span id="wti10d" class="chg-val">—</span>
            &nbsp;·&nbsp;
            30d: <span id="wti30d" class="chg-val">—</span>
          </div>
        </div>

        <div class="small text-muted mt-1">
          Último dato: <span id="wtiLastDate">—</span>
        </div>

        <canvas id="chartWti" height="140" class="mt-3"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Último comentario (en card) -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="card-title mb-0">Último comentario</h5>

      <div class="d-flex align-items-center gap-2">
        {% if markets_note_date %}
          <span class="badge bg-secondary">Actualizado: {{ markets_note_date }}</span>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role.name == 'admin' %}
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#marketsNoteModal">
            Nuevo comentario mercados
          </button>
        {% endif %}
      </div>
    </div>

    <div class="mt-3">
      <div class="text-body" style="white-space: pre-line;">
        {{ markets_note|trim|safe }}
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
{% if current_user.is_authenticated and current_user.role.name == 'admin' %}
  <div class="modal fade" id="marketsNoteModal" tabindex="-1" aria-labelledby="marketsNoteLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{{ url_for('markets.update_markets_note') }}" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="marketsNoteLabel">Editar comentario de mercados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <textarea name="content" rows="8" class="form-control" required>{{ markets_note }}</textarea>
          <small class="text-muted">Se reemplazará el comentario actual. Se guardará la fecha de hoy automáticamente.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
{% endif %}

<!-- Mapa estático (misma estructura responsiva que las demás tarjetas) -->
<div class="card shadow-sm mt-3">
  <div class="card-body text-center">
    <h5 class="card-title">Mapa de referencias</h5>
    <p class="text-muted mb-2">
      Ubicación aproximada de las principales referencias de <strong>petróleo crudo</strong> y <strong>gas natural</strong>.
    </p>
    <figure class="mb-0">
      <img
        src="{{ url_for('static', filename='images/map_benchmarks.jpg') }}"
        alt="Mapa de referencias de Brent, WTI, Dubai/Oman, Henry Hub, TTF y JKM"
        class="img-fluid rounded border d-block w-100"
        style="height:auto;"
      >
    </figure>
  </div>
</div>

<!-- Sección educativa: Petróleo crudo -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="card-title mb-0">Petróleo crudo: referencias clave</h5>
      <span class="badge bg-primary-subtle text-primary-emphasis">Guía rápida</span>
    </div>
    <div class="row mt-3 g-3">
      <div class="col-lg-7">
        <p class="text-muted">
          Los precios internacionales de crudo se guían por <em>benchmarks</em> (referencias) que representan calidades
          y geografías distintas. Los más consultados son:
        </p>
        <ul class="text-muted">
          <li><strong>Brent</strong> (Mar del Norte): referencia predominante en Europa, África y parte de Asia.</li>
          <li><strong>WTI</strong> (West Texas Intermediate, EE.&nbsp;UU.): referencia dominante en Norteamérica.</li>
          <li><strong>Dubai/Oman</strong> (Golfo Pérsico): referencia clave para crudos con destino Asia.</li>
        </ul>
        <p class="text-muted">
          Que existan varias referencias significa que dos precios pueden moverse de forma similar, pero no idéntica:
          influyen la calidad del crudo, la logística y las condiciones locales de oferta y demanda.
        </p>
      </div>
      <div class="col-lg-5">
        <div class="border rounded p-3 h-100">
          <div class="small text-uppercase text-muted mb-2">Comparativo rápido</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr><th>Referencia</th><th>Región</th><th>Uso típico</th></tr>
              </thead>
              <tbody class="text-muted">
                <tr><td>Brent</td><td>Mar del Norte</td><td>Europa/África/Asia</td></tr>
                <tr><td>WTI</td><td>EE.&nbsp;UU. (Texas)</td><td>Américas</td></tr>
                <tr><td>Dubai/Oman</td><td>Golfo Pérsico</td><td>Asia</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Tip: los diferenciales entre referencias (spreads) dan señales sobre flujos comerciales y balances regionales.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sección educativa: Gas natural -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="card-title mb-0">Gas natural: hubs e índices</h5>
      <span class="badge bg-primary-subtle text-primary-emphasis">Guía rápida</span>
    </div>
    <div class="row mt-3 g-3">
      <div class="col-lg-7">
        <p class="text-muted">
          A diferencia del crudo, el gas natural se comercializa con mayor dependencia de la infraestructura local
          (gasoductos) o como GNL (LNG) mediante cargamentos. Por eso, los precios de referencia suelen ser <em>hubs</em>
          físicos o índices regionales:
        </p>
        <ul class="text-muted">
          <li><strong>Henry Hub</strong> (EE.&nbsp;UU., Louisiana): precio spot y base de contratos en Norteamérica.</li>
          <li><strong>TTF</strong> (Países Bajos, Europa): principal referencia del gas europeo.</li>
          <li><strong>JKM</strong> (Japón-Corea): índice para cargamentos de GNL en Asia-Pacífico.</li>
        </ul>
        <p class="text-muted">
          El clima (frío/calor), inventarios, disponibilidad de GNL y restricciones de transporte pueden generar
          diferencias notables entre regiones, aun en el mismo periodo.
        </p>
      </div>
      <div class="col-lg-5">
        <div class="border rounded p-3 h-100">
          <div class="small text-uppercase text-muted mb-2">Comparativo rápido</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr><th>Referencia</th><th>Región</th><th>Producto</th></tr>
              </thead>
              <tbody class="text-muted">
                <tr><td>Henry Hub</td><td>EE.&nbsp;UU.</td><td>Gas natural</td></tr>
                <tr><td>TTF</td><td>Europa</td><td>Gas natural</td></tr>
                <tr><td>JKM</td><td>Asia-Pacífico</td><td>GNL (índice)</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Tip: los “basis” (diferencias entre hubs) reflejan cuellos de botella, estacionalidad y shocks de oferta/demanda.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script>
    function fmtPct(n){
      if (n == null) return "—";
      const s = (n >= 0 ? "+" : "") + n.toFixed(2) + "%";
      return s;
    }
    function fmtDateISO(d){
      if (!d) return "—";
      const dt = new Date(d + "T00:00:00Z");
      try { return dt.toLocaleDateString('es-ES', { year:'numeric', month:'short', day:'2-digit' }); }
      catch { return d; }
    }
    function setChange(el, n){
      el.textContent = fmtPct(n);
      el.classList.remove('text-success','text-danger');
      if (typeof n === 'number') el.classList.add(n >= 0 ? 'text-success' : 'text-danger');
    }

    async function loadDashboard(){
      const res = await fetch("{{ url_for('markets.mercados_json') }}", {cache: 'no-store'});
      const data = await res.json();
      const byId = {};
      for (const m of data.markets){ byId[m.id] = m; }

      function fmt1(n){
        if (n == null) return "—";
        const x = Number(n);
        return Number.isFinite(x) ? x.toFixed(1) : "—";
      }

      function setCard(prefix, m){
        document.getElementById(prefix+'Value').textContent = fmt1(m.value);
        document.getElementById(prefix+'Unit').textContent  = m.unit || '';
        setChange(document.getElementById(prefix+'10d'), m.chg_10d_pct);
        setChange(document.getElementById(prefix+'30d'), m.chg_30d_pct);
        document.getElementById(prefix+'Stale').style.display = m.stale ? 'inline-block' : 'none';
        document.getElementById(prefix+'LastDate').textContent = fmtDateISO(m.last_date);
      }

      setCard('brent', byId['brent'] || {});
      setCard('wti',   byId['wti']   || {});

      function drawLineWithDates(canvasId, dates, series){
        const canvas = document.getElementById(canvasId);
        if (!canvas || !Array.isArray(dates) || !Array.isArray(series) || dates.length !== series.length) return;

        const pts = dates.map((d, i) => ({ x: new Date(d + "T00:00:00Z").getTime(), y: series[i] }));

        new Chart(canvas, {
          type: 'line',
          data: {
            datasets: [{
              data: pts,
              borderColor: 'rgba(33,37,41,0.9)',
              fill: false,
              tension: 0.25,
              pointRadius: 2,
              pointHoverRadius: 5,
              pointBackgroundColor: 'rgba(33,37,41,0.85)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  title: items => {
                    const ts = items[0].parsed.x;
                    const d  = new Date(ts);
                    return d.toLocaleDateString('es-ES', { year:'numeric', month:'short', day:'2-digit' });
                  }
                }
              }
            },
            parsing: false,
            scales: {
              x: {
                type: 'time',
                time: { unit: 'day' },
                ticks: { maxTicksLimit: 8 },
                grid: { display: false }
              },
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(0,0,0,0.05)' }
              }
            },
            elements: { line: { borderWidth: 2 } }
          }
        });
      }

      drawLineWithDates('chartBrent', byId['brent']?.spark_dates || [], byId['brent']?.spark || []);
      drawLineWithDates('chartWti',   byId['wti']?.spark_dates   || [], byId['wti']?.spark   || []);
    }

    loadDashboard();
    // setInterval(loadDashboard, 15 * 60 * 1000);
  </script>
{% endblock %}
