{% extends "base.html" %}
{% block title %}Mercados – Canal Energético{% endblock %}

{% block content_top %}
<div class="bg-light p-3 rounded mb-3">
  <h1 class="mb-1">Mercados Energéticos</h1>
</div>
{% endblock %}

{% block content %}

<style>
  .chg-wrap{ font-size:1.05rem; }
  .chg-val{ font-weight:600; }
</style>

<div class="row g-3">
  <!-- Brent -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">Brent</h5>
          <span class="badge bg-secondary" id="brentStale" style="display:none;">Dato no reciente</span>
        </div>

        <div class="d-flex align-items-baseline flex-wrap gap-3 mt-2">
          <div class="d-flex align-items-baseline gap-2">
            <span class="display-6 fw-semibold" id="brentValue">—</span>
            <span class="text-muted" id="brentUnit">USD/bbl</span>
          </div>
          <div class="chg-wrap text-muted">
            10d: <span id="brent10d" class="chg-val">—</span>
            &nbsp;·&nbsp;
            30d: <span id="brent30d" class="chg-val">—</span>
          </div>
        </div>

        <div class="small text-muted mt-1">
          Último dato (EIA): <span id="brentLastDate">—</span>
        </div>

        <canvas id="chartBrent" height="140" class="mt-3"></canvas>
      </div>
    </div>
  </div>

  <!-- WTI -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="card-title mb-0">WTI</h5>
          <span class="badge bg-secondary" id="wtiStale" style="display:none;">Dato no reciente</span>
        </div>

        <div class="d-flex align-items-baseline flex-wrap gap-3 mt-2">
          <div class="d-flex align-items-baseline gap-2">
            <span class="display-6 fw-semibold" id="wtiValue">—</span>
            <span class="text-muted" id="wtiUnit">USD/bbl</span>
          </div>
          <div class="chg-wrap text-muted">
            10d: <span id="wti10d" class="chg-val">—</span>
            &nbsp;·&nbsp;
            30d: <span id="wti30d" class="chg-val">—</span>
          </div>
        </div>

        <div class="small text-muted mt-1">
          Último dato (EIA): <span id="wtiLastDate">—</span>
        </div>

        <canvas id="chartWti" height="140" class="mt-3"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Último comentario (actualizado) -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-baseline justify-content-between">
      <h5 class="card-title mb-0">Último comentario</h5>
      <small class="text-muted">03/09/2025</small>
    </div>
    <div class="mt-2 text-muted fst-italic">
      <p>El precio del petróleo Brent bajó a 67,8 dólares por barril este miércoles, luego de haber alcanzado un máximo de un mes más temprano en la jornada. Esta caída se debe a nuevos indicios de que podría haber más oferta de crudo en el mercado.</p>

      <p>Se reportó que la OPEP+ estaría considerando aumentar su producción de petróleo en la reunión prevista para este fin de semana, algo que sorprendió a los mercados, ya que se esperaba que mantuvieran los niveles actuales. Esta posible subida se sumaría a otros incrementos de producción realizados durante el año, con el objetivo de recuperar cuota de mercado y aumentar ingresos, a pesar de una demanda global más débil.</p>

      <p>Por otro lado, las exportaciones marítimas de petróleo ruso hacia China aumentaron fuertemente, tras una reducción de compras por parte de India debido a los fuertes aranceles impuestos por Estados Unidos.</p>

      <p>Además, en Estados Unidos, el panorama para la demanda de combustible se volvió más negativo tras publicarse un índice industrial (ISM PMI) más débil de lo esperado.</p>
    </div>
  </div>
</div>


<!-- Mapa estático -->
<div class="card shadow-sm mt-3 mx-auto" style="max-width: 900px;">
  <div class="card-body text-center">
    <h5 class="card-title">Mapa de referencias</h5>
    <p class="text-muted mb-2">
      Ubicación aproximada de las principales referencias de <strong>petróleo crudo</strong> y <strong>gas natural</strong>.
    </p>
    <figure class="mb-0">
      <img
        src="{{ url_for('static', filename='images/map_benchmarks.jpg') }}"
        alt="Mapa de referencias de Brent, WTI, Dubai/Oman, Henry Hub, TTF y JKM"
        class="img-fluid rounded border d-block mx-auto"
        style="max-width: 100%; height: auto;"
      >
    </figure>
  </div>
</div>

<!-- Sección educativa: Petróleo crudo -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="card-title mb-0">Petróleo crudo: referencias clave</h5>
      <span class="badge bg-primary-subtle text-primary-emphasis">Guía rápida</span>
    </div>
    <div class="row mt-3 g-3">
      <div class="col-lg-7">
        <p class="text-muted">
          Los precios internacionales de crudo se guían por <em>benchmarks</em> (referencias) que representan calidades
          y geografías distintas. Los más consultados son:
        </p>
        <ul class="text-muted">
          <li><strong>Brent</strong> (Mar del Norte): referencia predominante en Europa, África y parte de Asia.</li>
          <li><strong>WTI</strong> (West Texas Intermediate, EE.&nbsp;UU.): referencia dominante en Norteamérica.</li>
          <li><strong>Dubai/Oman</strong> (Golfo Pérsico): referencia clave para crudos con destino Asia.</li>
        </ul>
        <p class="text-muted">
          Que existan varias referencias significa que dos precios pueden moverse de forma similar, pero no idéntica:
          influyen la calidad del crudo, la logística y las condiciones locales de oferta y demanda.
        </p>
      </div>
      <div class="col-lg-5">
        <div class="border rounded p-3 h-100">
          <div class="small text-uppercase text-muted mb-2">Comparativo rápido</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr><th>Referencia</th><th>Región</th><th>Uso típico</th></tr>
              </thead>
              <tbody class="text-muted">
                <tr><td>Brent</td><td>Mar del Norte</td><td>Europa/África/Asia</td></tr>
                <tr><td>WTI</td><td>EE.&nbsp;UU. (Texas)</td><td>Américas</td></tr>
                <tr><td>Dubai/Oman</td><td>Golfo Pérsico</td><td>Asia</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Tip: los diferenciales entre referencias (spreads) dan señales sobre flujos comerciales y balances regionales.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sección educativa: Gas natural -->
<div class="card shadow-sm mt-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="card-title mb-0">Gas natural: hubs e índices</h5>
      <span class="badge bg-primary-subtle text-primary-emphasis">Guía rápida</span>
    </div>
    <div class="row mt-3 g-3">
      <div class="col-lg-7">
        <p class="text-muted">
          A diferencia del crudo, el gas natural se comercializa con mayor dependencia de la infraestructura local
          (gasoductos) o como GNL (LNG) mediante cargamentos. Por eso, los precios de referencia suelen ser <em>hubs</em>
          físicos o índices regionales:
        </p>
        <ul class="text-muted">
          <li><strong>Henry Hub</strong> (EE.&nbsp;UU., Louisiana): precio spot y base de contratos en Norteamérica.</li>
          <li><strong>TTF</strong> (Países Bajos, Europa): principal referencia del gas europeo.</li>
          <li><strong>JKM</strong> (Japón-Corea): índice para cargamentos de GNL en Asia-Pacífico.</li>
        </ul>
        <p class="text-muted">
          El clima (frío/calor), inventarios, disponibilidad de GNL y restricciones de transporte pueden generar
          diferencias notables entre regiones, aun en el mismo periodo.
        </p>
      </div>
      <div class="col-lg-5">
        <div class="border rounded p-3 h-100">
          <div class="small text-uppercase text-muted mb-2">Comparativo rápido</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr><th>Referencia</th><th>Región</th><th>Producto</th></tr>
              </thead>
              <tbody class="text-muted">
                <tr><td>Henry Hub</td><td>EE.&nbsp;UU.</td><td>Gas natural</td></tr>
                <tr><td>TTF</td><td>Europa</td><td>Gas natural</td></tr>
                <tr><td>JKM</td><td>Asia-Pacífico</td><td>GNL (índice)</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Tip: los “basis” (diferencias entre hubs) reflejan cuellos de botella, estacionalidad y shocks de oferta/demanda.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script>
    function fmtPct(n){
      if (n == null) return "—";
      const s = (n >= 0 ? "+" : "") + n.toFixed(2) + "%";
      return s;
    }
    function fmtDateISO(d){
      if (!d) return "—";
      const dt = new Date(d + "T00:00:00Z");
      try { return dt.toLocaleDateString('es-ES', { year:'numeric', month:'short', day:'2-digit' }); }
      catch { return d; }
    }
    function setChange(el, n){
      el.textContent = fmtPct(n);
      el.classList.remove('text-success','text-danger');
      if (typeof n === 'number') el.classList.add(n >= 0 ? 'text-success' : 'text-danger');
    }

    async function loadDashboard(){
      const res = await fetch("{{ url_for('main.mercados_json') }}", {cache: 'no-store'});
      const data = await res.json();
      const byId = {};
      for (const m of data.markets){ byId[m.id] = m; }

      function setCard(prefix, m){
        document.getElementById(prefix+'Value').textContent = (m.value ?? '—');
        document.getElementById(prefix+'Unit').textContent  = m.unit || '';
        setChange(document.getElementById(prefix+'10d'), m.chg_10d_pct);
        setChange(document.getElementById(prefix+'30d'), m.chg_30d_pct);
        document.getElementById(prefix+'Stale').style.display = m.stale ? 'inline-block' : 'none';
        document.getElementById(prefix+'LastDate').textContent = fmtDateISO(m.last_date);
      }

      setCard('brent', byId['brent'] || {});
      setCard('wti',   byId['wti']   || {});

      function drawLineWithDates(canvasId, dates, series){
        const canvas = document.getElementById(canvasId);
        if (!canvas || !Array.isArray(dates) || !Array.isArray(series) || dates.length !== series.length) return;

        // Convertimos a timestamps (ms) para evitar problemas de parsing
        const pts = dates.map((d, i) => ({ x: new Date(d + "T00:00:00Z").getTime(), y: series[i] }));

        new Chart(canvas, {
          type: 'line',
          data: {
            datasets: [{
              data: pts,
              borderColor: 'rgba(33,37,41,0.9)',
              fill: false,
              tension: 0.25,
              pointRadius: 2,
              pointHoverRadius: 5,
              pointBackgroundColor: 'rgba(33,37,41,0.85)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  title: items => {
                    const ts = items[0].parsed.x;
                    const d  = new Date(ts);
                    return d.toLocaleDateString('es-ES', { year:'numeric', month:'short', day:'2-digit' });
                  }
                }
              }
            },
            parsing: false,
            scales: {
              x: {
                type: 'time',
                time: { unit: 'day' },
                ticks: { maxTicksLimit: 8 },
                grid: { display: false }
              },
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(0,0,0,0.05)' }
              }
            },
            elements: { line: { borderWidth: 2 } }
          }
        });
      }

      drawLineWithDates('chartBrent', byId['brent']?.spark_dates || [], byId['brent']?.spark || []);
      drawLineWithDates('chartWti',   byId['wti']?.spark_dates   || [], byId['wti']?.spark   || []);
    }

    loadDashboard();
    // setInterval(loadDashboard, 15 * 60 * 1000);
  </script>
{% endblock %}
